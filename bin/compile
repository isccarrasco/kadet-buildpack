#!/usr/bin/env bash

# fail fast
set -eo pipefail

# Setup Path variables, for later use in the Buildpack.
BIN_DIR=$(cd "$(dirname "$0")"; pwd) # absolute path
ROOT_DIR=$(dirname "$BIN_DIR")
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3


indent() {
  sed -u 's/^/       /'
}

cleanup() {
  sed -e 's/\.\.\.\+/.../g' | sed -e '/already satisfied/Id' | sed -e '/No files were found to uninstall/Id' | sed -e '/Overwriting/Id' | sed -e '/python executable/Id' | sed -e '/no previously-included files/Id'
}

export_env_dir() {
  env_dir=$1
  acceptlist_regex=${2:-''}
  denylist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$acceptlist_regex" | grep -qvE "$denylist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

echo "-----> Installing packages required for KADET-Core"

# if BITBUCKET_TOKEN variable exists, install the KADET-Core library
# otherwise error

if [ ! -f "$ENV_DIR/BITBUCKET_TOKEN" ]; then
  echo "The BITBUCKET_TOKEN variable for accessing the repository is missing."
  exit 1
else
  echo "Loading variables" | cleanup | indent
  export_env_dir $ENV_DIR

  # echo "Installing gosdt library" | cleanup | indent
  # git clone https://github.com/Jimmy-Lin/GeneralizedOptimalSparseDecisionTrees.git gosdt  | cleanup | indent
  # cd gosdt
  # mkdir m4

  # mkdir bin
  # export DESTDIR="/app/gosdt/bin"

  # echo "Preparing missing variables" | cleanup | indent
  # aclocal  | cleanup | indent
  # automake --add-missing  | cleanup | indent

  # echo "Configure and Install GOSDT" | cleanup | indent
  # ./autobuild --install  | cleanup | indent

  # echo "Install GOSDT as Python lib" | cleanup | indent
  # ./autobuild --install-python  | cleanup | indent

  echo "Installing dependencies" | cleanup | indent
  
  /app/.heroku/python/bin/python -m pip install --upgrade pip  | cleanup | indent
  /app/.heroku/python/bin/pip install Cython --install-option="--no-cython-compile"  | cleanup | indent
  #/app/.heroku/python/bin/pip install sklearn numpy pandas | cleanup | indent
  #/app/.heroku/python/bin/pip install ipython  | cleanup | indent
  /app/.heroku/python/bin/pip install gmpy2  | cleanup | indent
  echo "finishing dependencies instalation"  | cleanup | indent

  # echo "Installing KADET from git repository"  | cleanup | indent
  # /app/.heroku/python/bin/pip install git+https://isccarrasco:$BITBUCKET_TOKEN@bitbucket.org/koneksys/automl_decision_trees.git#egg=kadet-lib  | cleanup | indent

fi | indent

